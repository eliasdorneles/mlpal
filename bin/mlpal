#!/usr/bin/env python

import argparse
import sys
import os
import yaml
from collections import defaultdict
from datetime import datetime

def load_config():
    # TODO read $MLPAL_TESTS
    name = 'config.yaml'
    if os.path.exists(name):
        print("%s was found, loading." % name)
        return yaml.load(open(name))
    return {}

def parse_args(config):
    print(config)

    defaults = defaultdict(lambda: None)
    for k, v in config.iteritems():
        defaults[k] = v

    tasks = ['train', 'search', 'benchmark',
             'learning_curves', 'plot_pca', 'misclassified']

    parser = argparse.ArgumentParser()

    parser.add_argument("task", choices=tasks, help="The task to be run")
    parser.add_argument("setup", help="Python module with the running definitions")
    parser.add_argument("-d", help="Launch debugger on exception", action='store_true')
    parser.add_argument("-n", help="Sample size", type=int, default=defaults['n'])
    parser.add_argument("-j", help="# of jobs", type=int, default=defaults.get('j', 1))
    parser.add_argument("-o", help="Output files prefix.", type=str, default=defaults['o'])
    parser.add_argument("-f", help="Force", action='store_true')
    parser.add_argument("-q", help="Less verbosity on STDOUT",
        action='store_true', default=defaults.get('q', False))

    parser.add_argument("--begin", type=int,
        help="The size of the smallest training set used to plot the learning curves",
        default=defaults.get('begin', 30))

    parser.add_argument("--points", type=int,
        help="Number of points in the learning curves",
        default=defaults.get('points', 8))

    parser.add_argument("--space", type=str, choices=['log', 'linear'],
        help="How are the points going to be spread in the space?",
        default=defaults.get('space', 'log'))

    parser.add_argument("--clfpath", default='dumps/last.pickle',
        help="Serialized classifier path (benchmarks only)")

    parser.add_argument("--tests", help="Loads the mlpal in the current dir", action='store_true')

    parser.add_argument("--cv", type=int, default=defaults.get('cv', 10),
        help="Number of cv iterations", )

    parser.add_argument("--random-state", help="Pseudo random number generator state", type=int, default=defaults['random_state'])

    default_log_name = 'lastrun-%s.log' % datetime.now().strftime('%Y%m%d_%H%M%S')
    parser.add_argument("--log-to", type=str, help="Log file path",
        default=defaults.get('log_to', default_log_name))

    return parser.parse_args()

args = parse_args(load_config())

if args.tests:
    # there must be a better way to load the module for testing
    mlpal_local_path = os.path.realpath('.')
    sys.path.insert(0, mlpal_local_path)

from mlpal.runner import run

if args.d:
    from ipdb import launch_ipdb_on_exception
    with launch_ipdb_on_exception():
        run(args)
else:
    run(args)
